# mvp28-fix 项目开发汇总文档

> 面向项目汇报的开发说明：按“模块 -> 功能 -> 关键代码标记（文件 + 关键函数/导出 + 行号范围）”组织。  
> 行号基于当前仓库版本统计，后续若代码变更行号会随之漂移。

## 1、代码与模块说明（Implemented Modules）

### M01 版本隔离与全局中间件（Geo / CORS / CSRF / Admin Guard）

**实现了什么**
- 应用按部署版本强制隔离：国内版（`zh`）禁止访问国际接口与 Stripe/PayPal；国际版（`en`）禁止访问国内接口与微信/支付宝/国内 webhook，避免“跨库/跨支付通道”旁路访问。
- 管理后台 `/admin` 的登录态保护：未登录自动重定向到 `/admin/login`。
- API 统一处理 CORS 预检、请求体大小限制、生产环境禁用调试参数等安全策略。
- 基于 IP/地理信息的访问控制与响应头注入（GDPR/区域策略）。

**关键代码标记**
- File Path: `middleware.ts`
  - `verifyAdminSessionToken()`：L13-L47
  - `middleware()`：L48-L464
  - `config`：L465-L475
- File Path: `lib/architecture-modules/core/geo-router.ts`
  - `GeoRouter`：L19-L434
  - `geoRouter`：L435-L435
- File Path: `lib/security/csrf.ts`
  - `csrfProtection()`：L158-L244
  - `generateCSRFToken()`：L245-L271

---

### M02 双版本与双数据源接入（国内 CloudBase / 国际 Supabase）

**实现了什么**
- 国内版以 CloudBase 作为数据库/存储/认证的基础设施；国际版以 Supabase（PostgreSQL + Auth + Storage）作为基础设施。
- 对两套数据源提供独立连接与客户端创建方式，配合 `middleware.ts` 做“版本隔离”，保证部署后不会串库。

**关键代码标记**
- File Path: `config/index.ts`
  - `DEFAULT_LANGUAGE` / `IS_DOMESTIC_VERSION`：L5-L8
  - `MODEL_CONFIG` / `getCurrentModelConfig()`：L11-L49
- File Path: `lib/cloudbase/connector.ts`
  - `CloudBaseConnector`：L16-L79
- File Path: `lib/supabase/server.ts`
  - `createClient()`：L12-L37
- File Path: `lib/supabase/client.ts`
  - `createClient()`：L11-L33
- File Path: `lib/supabaseAdmin.ts`
  - `supabaseAdmin` 初始化（服务端 Service Role）：L1-L18

---

### M03 用户认证（国内邮箱/微信扫码；国际 Google OAuth；管理员登录）

**实现了什么**
- 国内版：邮箱+密码注册/登录、微信扫码登录；登录成功写入 `auth-token`（HttpOnly Cookie）。
- 国际版：基于 Supabase 的 Google OAuth（PKCE），并在回调页落地会话。
- 管理后台：独立的管理员认证与会话 Cookie（`admin_session`），与普通用户体系分离。

**关键代码标记**
- File Path: `app/api/auth/login/route.ts`
  - `POST()`（国内邮箱登录，写入 `auth-token`）：L7-L54
- File Path: `app/api/auth/register/route.ts`
  - `POST()`（国内邮箱注册）：L7-L54
- File Path: `app/api/auth/wechat/qrcode/route.ts`
  - `GET()`（生成/获取微信扫码参数）：L9-L66
- File Path: `app/api/auth/wechat/route.ts`
  - `POST()`（微信扫码登录落库并写入 `auth-token`）：L10-L116
- File Path: `app/api/auth/me/route.ts`
  - `GET()`（读取当前登录用户）：L14-L99
- File Path: `app/api/auth/logout/route.ts`
  - `POST()`（清理登录态）：L6-L21
- File Path: `lib/cloudbase/auth.ts`
  - `CloudBaseAuthService`：L56-L387
  - `signInWithEmail()`：L75-L111
  - `signUpWithEmail()`：L112-L153
  - `validateToken()`：L154-L182
  - `signInWithWechat()`：L183-L387
- File Path: `actions/oauth.ts`
  - `signInWithGoogle()`（服务端启动 OAuth，写入 PKCE cookie）：L15-L73
- File Path: `app/api/auth/oauth/google/route.ts`
  - `GET()`（OAuth 回调处理/跳转）：L14-L98
- File Path: `actions/admin-auth.ts`
  - `adminLogin()` / `changePassword()` / `getCurrentAdmin()`：L61-L209
- File Path: `utils/session.ts`
  - `createAdminSession()` / `getAdminSession()`：L58-L121

---

### M04 会话与消息（Conversation / Messages）

**实现了什么**
- 统一的会话列表、创建、重命名、删除；按国内/国际版本落到 CloudBase / Supabase。
- 针对 Free 用户做“轻量策略”：不读库/不落库，返回本地临时会话 ID，避免无意义的存储成本。

**关键代码标记**
- File Path: `app/api/conversations/route.ts`
  - `GET()`（会话列表；Free 用户返回空列表）：L42-L127
  - `POST()`（创建会话；Free 用户返回本地临时会话）：L128-L242
- File Path: `app/api/conversations/[id]/route.ts`
  - `DELETE()`（删除会话）：L28-L107
  - `PATCH()`（更新会话标题/模型等）：L108-L165
- File Path: `app/api/conversations/[id]/messages/route.ts`
  - `GET()`（读取消息列表）：L107-L188
  - `POST()`（新增消息）：L189-L530
  - `DELETE()`（删除消息）：L531-L622

---

### M05 AI 聊天（国内 DashScope / 国际 Mistral；流式输出；专家模型）

**实现了什么**
- 国内版：对接阿里云 DashScope 的 OpenAI 兼容接口，支持流式输出；根据输入是否带媒体自动选择多模态模型。
- 国际版：对接 Mistral Chat Completions，支持流式输出；并保留多模态校验逻辑（当前国际版对多模态返回明确提示）。
- 专家模型：通过 `expertModelId` 选择垂直领域 prompt/配置，并限制为文本能力。

**关键代码标记**
- File Path: `app/api/domestic/chat/stream/route.ts`
  - `POST` 复用登录用户逻辑（re-export）：L1-L2
- File Path: `app/api/domestic/chat/stream-guest/route.ts`
  - `POST()`（国内版流式聊天 + 配额校验/扣减）：L115-L630
- File Path: `app/api/domestic/chat/send/route.ts`
  - `POST` 复用逻辑（re-export）：L1-L2
- File Path: `app/api/domestic/chat/send-guest/route.ts`
  - `POST()`（国内版非流式发送 + 配额逻辑）：L122-L417
- File Path: `app/api/international/chat/stream/route.ts`
  - `POST()`（国际版登录用户流式聊天 + 配额）：L105-L471
- File Path: `app/api/international/chat/stream-guest/route.ts`
  - `POST()`（国际版游客流式聊天）：L80-L394
- File Path: `constants/expert-models.ts`
  - `EXPERT_MODELS` / `isExpertModelId()` / `getExpertModelDefinition()`：L28-L162
- File Path: `utils/model-limits.ts`
  - 模型分类与上下文/配额规则：L15-L396

---

### M06 多模态与媒体处理（上传/解析/删除；相机/录音/附件）

**实现了什么**
- 国内版支持图片/视频/音频的上传与消息关联；客户端侧支持相机拍摄、视频录制、语音录制与附件列表管理。
- 提供媒体资源解析接口：将存储层的标识（如 CloudBase fileID）解析为可访问的临时 URL，并支持删除媒体。

**关键代码标记**
- File Path: `app/api/domestic/upload/route.ts`
  - `POST()`（通用上传）：L26-L87
  - `DELETE()`（删除上传内容）：L88-L115
- File Path: `app/api/domestic/audio/upload/route.ts`
  - `POST()` / `DELETE()`：L25-L104
- File Path: `app/api/domestic/video/upload/route.ts`
  - `POST()` / `DELETE()`：L25-L114
- File Path: `app/api/domestic/media/resolve/route.ts`
  - `POST()`（批量解析媒体 ID -> URL）：L19-L52
- File Path: `app/api/domestic/media/delete/route.ts`
  - `POST()`（删除媒体资源）：L6-L35
- File Path: `components/InputArea.tsx`
  - `InputArea`（输入区：附件/语音/相机/快捷操作等 UI 聚合）：L163-L1358
- File Path: `features/chat/components/input/CameraPanel.tsx`
  - `CameraPanel`（相机预览/拍照/录制）：L20-L121
- File Path: `hooks/useCamera.ts`
  - `useCamera`（相机能力封装）：L3-L274
- File Path: `hooks/useVoiceRecording.ts`
  - `useVoiceRecording`（录音与转写流程封装）：L3-L270

---

### M07 配额与钱包系统（订阅额度 / 加油包 / 日配额 / 月配额 / 升级补差价）

**实现了什么**
- 按套餐（Free/Basic/Pro/Enterprise）管理：每日外部模型额度、每月图片额度、每月视频/音频额度。
- 支持订阅续费、到期降级、升级补差价；加油包作为永久额度叠加。
- 国内与国际分别落库到 CloudBase / Supabase（逻辑尽量对齐），API 侧统一通过 `/api/account/quota` 暴露给前端。

**关键代码标记**
- File Path: `services/wallet.ts`（国内版钱包/配额）
  - `seedWalletForPlan()`：L275-L371
  - `checkDailyExternalQuota()` / `consumeDailyExternalQuota()`：L692-L795
  - `consumeQuota()` / `checkQuota()`：L796-L931
  - `calculateUpgradePrice()`：L932-L958
- File Path: `services/wallet-supabase.ts`（国际版钱包/配额）
  - `seedSupabaseWalletForPlan()`：L429-L627
  - `checkSupabaseDailyExternalQuota()` / `consumeSupabaseDailyExternalQuota()`：L859-L970
  - `consumeSupabaseQuota()` / `checkSupabaseQuota()`：L681-L1048
  - `calculateSupabaseUpgradePrice()`：L971-L1005
- File Path: `app/api/account/quota/route.ts`
  - `GET()`（读取并汇总配额/订阅信息）：L60-L444
- File Path: `utils/quota-fetcher.ts`
  - `fetchQuotaShared()`（前端去重/缓存，避免重复轮询）：L7-L30

---

### M08 支付与订阅（微信/支付宝/Stripe/PayPal；Webhook 幂等处理）

**实现了什么**
- 国内版：微信支付/支付宝下单、支付确认、订单查询与 webhook 回调。
- 国际版：Stripe/PayPal 下单、支付确认/捕获与 webhook 回调。
- webhook 统一处理器保证幂等：同一事件只处理一次，并写入事件表/集合进行追踪。
- 支持订阅与加油包两类商品（同一支付链路内分支处理）。

**关键代码标记**
- File Path: `app/api/payment/wechat/create/route.ts`
  - `POST()`（微信下单）：L65-L336
- File Path: `app/api/payment/wechat/confirm/route.ts`
  - `POST()`（微信确认/写入订阅状态）：L32-L414
- File Path: `app/api/payment/wechat/query/route.ts`
  - `GET()`（微信订单查询）：L9-L57
- File Path: `app/api/payment/alipay/create/route.ts`
  - `POST()`（支付宝下单）：L51-L319
- File Path: `app/api/payment/alipay/confirm/route.ts`
  - `POST()`（支付宝确认/写入订阅状态）：L32-L406
- File Path: `app/api/payment/webhook/wechat/route.ts`
  - `POST()`（微信支付回调入口）：L34-L782
- File Path: `app/api/payment/webhook/alipay/route.ts`
  - `POST()`（支付宝回调入口）：L31-L405
- File Path: `app/api/payment/stripe/create/route.ts`
  - `POST()`（Stripe 下单；含订阅/加油包/补差价）：L59-L327
- File Path: `lib/stripe.ts`
  - `createStripeCheckoutSession()` / `verifyStripeWebhook()`：L19-L123
- File Path: `lib/paypal.ts`
  - `createPayPalOrder()` / `capturePayPalOrder()`：L37-L107
- File Path: `lib/payment/webhook-handler.ts`
  - `WebhookHandler.processWebhook()`：L29-L258

---

### M09 管理后台（广告位 / 社交链接 / 应用发布包 管理；双端同步）

**实现了什么**
- 管理后台页面（`/admin/*`）提供广告位、社交链接、版本发布包的增删改查与文件上传。
- 支持双端同步：国际版写入 Supabase（表 + Storage），国内版写入 CloudBase（集合 + Storage）。
- 对外提供“活跃数据”公开 API，供前台展示（广告、社交入口、升级下载等）。

**关键代码标记**
- File Path: `app/admin/login/page.tsx`
  - 管理员登录页（`AdminLoginPage`）：L19-L106
- File Path: `actions/admin-ads.ts`
  - `createAdvertisement()` / `updateAdvertisement()` / `deleteAdvertisement()`：L173-L693
  - `listStorageFiles()`（存储文件列表）：L694-L883
- File Path: `actions/admin-social-links.ts`
  - `createSocialLink()` / `updateSocialLink()` / `deleteSocialLink()`：L158-L617
  - `updateSocialLinksOrder()`：L618-L656
- File Path: `actions/admin-releases.ts`
  - `createRelease()` / `updateRelease()` / `deleteRelease()`：L159-L639
  - `getLatestRelease()`：L640-L766
- File Path: `app/api/ads/active/route.ts`
  - `GET()`（获取活跃广告）：L29-L182
- File Path: `app/api/social-links/active/route.ts`
  - `GET()`（获取活跃社交链接）：L21-L161
- File Path: `app/api/releases/active/route.ts`
  - `GET()`（获取最新活跃发布包）：L29-L197

---

### M10 前端主界面与交互能力（聊天壳层 / 广告展示 / 配额展示 / 多语言）

**实现了什么**
- 首页即聊天界面：侧边栏会话管理 + 顶部 Header + 消息区 + 输入区；模态框聚合（登录、订阅、分享、设置等）。
- 广告展示与去广告逻辑：订阅用户可开启隐藏广告；Free 用户可关闭并触发升级弹窗。
- 全局多语言（zh/en）与文案获取能力，配合版本隔离形成“同一代码库、两套部署体验”。

**关键代码标记**
- File Path: `components/MornGPTHomepage.tsx`
  - `MornGPTHomepage()`（装配 ChatProvider + ChatShell）：L7-L13
- File Path: `features/chat/providers/ChatProvider.tsx`
  - `useChatUI()`：L130-L142
  - `ChatProvider()`：L275-L4821
- File Path: `features/chat/components/ChatShell.tsx`
  - `ChatShell()`（布局与广告展示策略）：L8-L180
- File Path: `features/chat/components/ModalHub.tsx`
  - `ModalHub()`（全局弹窗容器）：L28-L384
- File Path: `components/QuotaDisplay.tsx`
  - `QuotaDisplay()`（配额 UI + 拉取/展示）：L106-L716
- File Path: `lib/localization.ts`
  - `getLocalizedText()` / `createLocalizedTextGetter()`：L364-L371
