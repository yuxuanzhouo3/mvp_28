<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sign-In è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Google Sign-In è¯Šæ–­å·¥å…·</h1>

    <div class="section info">
        <h2>1. ç¯å¢ƒæ£€æµ‹</h2>
        <div id="env-check"></div>
    </div>

    <div class="section">
        <h2>2. Bridge æµ‹è¯•</h2>
        <button onclick="testBridge()">æµ‹è¯• Bridge</button>
        <div id="bridge-result"></div>
    </div>

    <div class="section">
        <h2>3. Google ç™»å½•æµ‹è¯•</h2>
        <button onclick="testGoogleSignIn()">æµ‹è¯• Google ç™»å½•</button>
        <div id="signin-result"></div>
    </div>

    <div class="section">
        <h2>4. åç«¯ API æµ‹è¯•</h2>
        <button onclick="testBackendAPI()">æµ‹è¯•åç«¯ API</button>
        <div id="api-result"></div>
    </div>

    <script>
        const CLIENT_ID = '45279353784-q2fb18s5oak3he9q91dvu8pv39154oe4.apps.googleusercontent.com';

        // 1. ç¯å¢ƒæ£€æµ‹
        function checkEnvironment() {
            const envCheck = document.getElementById('env-check');
            const checks = [];

            checks.push(`âœ“ User Agent: ${navigator.userAgent}`);
            checks.push(`âœ“ Window å¯¹è±¡å­˜åœ¨: ${typeof window !== 'undefined'}`);
            checks.push(`âœ“ GoogleSignIn Bridge å­˜åœ¨: ${typeof window.GoogleSignIn !== 'undefined'}`);

            if (window.GoogleSignIn) {
                checks.push(`âœ“ GoogleSignIn.signIn æ–¹æ³•: ${typeof window.GoogleSignIn.signIn === 'function'}`);
                checks.push(`âœ“ GoogleSignIn.signOut æ–¹æ³•: ${typeof window.GoogleSignIn.signOut === 'function'}`);
                checks.push(`âœ“ GoogleSignIn.getCurrentUser æ–¹æ³•: ${typeof window.GoogleSignIn.getCurrentUser === 'function'}`);
            } else {
                checks.push(`âœ— GoogleSignIn Bridge æœªæ‰¾åˆ°ï¼è¿™æ˜¯ä¸»è¦é—®é¢˜ï¼`);
            }

            envCheck.innerHTML = '<pre>' + checks.join('\n') + '</pre>';
        }

        // 2. Bridge æµ‹è¯•
        function testBridge() {
            const result = document.getElementById('bridge-result');
            result.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';

            if (!window.GoogleSignIn) {
                result.innerHTML = '<pre class="error">é”™è¯¯ï¼šGoogleSignIn Bridge ä¸å­˜åœ¨ï¼\n\nå¯èƒ½åŸå› ï¼š\n1. MainActivity ä¸­ Bridge æœªæ­£ç¡®æ³¨å†Œ\n2. WebView æœªå®Œå…¨åŠ è½½\n3. Android åº”ç”¨ç‰ˆæœ¬é—®é¢˜</pre>';
                return;
            }

            try {
                const currentUser = window.GoogleSignIn.getCurrentUser();
                result.innerHTML = `<pre class="success">âœ“ Bridge å¯ç”¨ï¼\nå½“å‰ç”¨æˆ·: ${currentUser || 'æœªç™»å½•'}</pre>`;
            } catch (error) {
                result.innerHTML = `<pre class="error">âœ— Bridge è°ƒç”¨å¤±è´¥ï¼š${error.message}</pre>`;
            }
        }

        // 3. Google ç™»å½•æµ‹è¯•
        function testGoogleSignIn() {
            const result = document.getElementById('signin-result');
            result.innerHTML = '<p>æ­£åœ¨è°ƒç”¨ Google ç™»å½•...</p>';

            if (!window.GoogleSignIn) {
                result.innerHTML = '<pre class="error">é”™è¯¯ï¼šGoogleSignIn Bridge ä¸å­˜åœ¨ï¼</pre>';
                return;
            }

            const callbackName = `testCallback_${Date.now()}`;
            window[callbackName] = function(response) {
                console.log('[è¯Šæ–­å·¥å…·] Google ç™»å½•å›è°ƒ:', response);
                delete window[callbackName];

                if (response.success) {
                    result.innerHTML = `<pre class="success">âœ“ Google ç™»å½•æˆåŠŸï¼\n\nID Token: ${response.idToken ? 'å·²è·å–' : 'æœªè·å–'}\nEmail: ${response.email}\nDisplay Name: ${response.displayName}</pre>`;
                } else {
                    result.innerHTML = `<pre class="error">âœ— Google ç™»å½•å¤±è´¥ï¼š${response.error}</pre>`;
                }
            };

            try {
                console.log('[è¯Šæ–­å·¥å…·] è°ƒç”¨ signInï¼ŒClient ID:', CLIENT_ID);
                window.GoogleSignIn.signIn(CLIENT_ID, callbackName);
            } catch (error) {
                result.innerHTML = `<pre class="error">âœ— è°ƒç”¨å¤±è´¥ï¼š${error.message}</pre>`;
            }
        }

        // 4. åç«¯ API æµ‹è¯•
        async function testBackendAPI() {
            const result = document.getElementById('api-result');
            result.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';

            const testToken = 'test-token-for-debugging';

            try {
                const response = await fetch('/api/auth/google-native', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idToken: testToken,
                        email: 'test@example.com',
                        displayName: 'Test User'
                    })
                });

                const data = await response.json();

                result.innerHTML = `<pre>çŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                result.innerHTML = `<pre class="error">âœ— API è°ƒç”¨å¤±è´¥ï¼š${error.message}</pre>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
        window.addEventListener('load', checkEnvironment);
    </script>
</body>
</html>
