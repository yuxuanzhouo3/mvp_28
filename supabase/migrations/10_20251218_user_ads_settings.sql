-- ===========================================================================
-- 用户广告设置迁移 (User Ads Settings Migration)
-- 为订阅用户添加去除广告的设置字段
-- ===========================================================================

-- 1. 在 profiles 表中添加 hide_ads 字段
-- 用于存储订阅用户是否开启去除广告功能
-- 默认为 false，订阅用户需要在【下载 MornGPT】页面的【广告设置】中手动开启
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS hide_ads boolean DEFAULT false;

-- 2. 添加注释说明字段用途
COMMENT ON COLUMN public.profiles.hide_ads IS '订阅用户是否开启去除广告功能。默认false，需在广告设置中手动开启。订阅到期后自动失效恢复广告显示。';

-- 3. 创建索引以优化查询（可选，如果需要按此字段筛选用户）
CREATE INDEX IF NOT EXISTS idx_profiles_hide_ads ON public.profiles(hide_ads) WHERE hide_ads = true;

-- ===========================================================================
-- 广告显示逻辑说明：
-- ===========================================================================
--
-- 1. Free 用户：始终显示广告，可手动关闭单个广告（刷新后恢复），关闭后弹出订阅提示
-- 2. 订阅用户 + hide_ads = false：正常显示广告
-- 3. 订阅用户 + hide_ads = true + 订阅有效：不显示广告
-- 4. 订阅用户 + hide_ads = true + 订阅过期：自动恢复广告显示
--
-- 侧边栏小眼睛图标：
-- - 默认状态：显示 Eye 图标（表示广告正在显示）
-- - 点击后：切换到 EyeOff 图标，仅关闭侧边栏广告并显示社交链接列表
-- - 此操作不影响其他位置的广告显示
--
-- ===========================================================================
-- 国内版 CloudBase 数据库变更说明：
-- ===========================================================================
--
-- CloudBase 没有 profiles 集合，用户信息存储在 【users】 集合中。
-- 需要在 【users】 集合中添加以下字段：
--
-- 字段名：hide_ads
-- 类型：Boolean
-- 默认值：false
-- 说明：订阅用户是否开启去除广告功能
--
-- 示例文档结构：
-- {
--   "_id": "4289fa816940daa607e829b81301fdb2",
--   "email": "user@example.com",
--   "name": "用户名",
--   "plan": "Basic",
--   "plan_exp": "2026-01-15T05:51:42.087Z",
--   "pro": true,
--   "hide_ads": false,  // <-- 新增字段
--   "wallet": { ... },
--   ...
-- }
--
-- ===========================================================================
